# Backend Implementation Plan: Onboarding-as-a-Service (OaaS)

## Technology Stack
- **Framework:** FastAPI
- **Database:** PostgreSQL with SQLAlchemy ORM
- **Authentication:** JWT tokens
- **File Storage:** S3-compatible storage (AWS S3, MinIO, etc.)
- **Message Queue:** Redis for background tasks
- **Validation:** Pydantic models
- **Documentation:** OpenAPI/Swagger (auto-generated by FastAPI)

---

## Milestone 1: Project Setup & Core Infrastructure

### 1.1 Project Structure

```
backend/
├── app/
│   ├── __init__.py
│   ├── main.py                 # FastAPI app
│   ├── config.py               # Settings
│   ├── database.py             # Database connection
│   ├── dependencies.py         # Dependency injection
│   ├── auth/                   # Authentication
│   ├── models/                 # SQLAlchemy models
│   ├── schemas/                # Pydantic schemas
│   ├── api/                    # API routes
│   ├── services/               # Business logic
│   ├── utils/                  # Utilities
│   └── migrations/             # Database migrations
├── requirements.txt
├── alembic.ini                 # Database migrations
└── docker-compose.yml
```

### 1.2 Database Models (SQLAlchemy)

#### Core Entities
```python
# models/company.py
class Company(Base):
    id = Column(UUID, primary_key=True)
    name = Column(String, nullable=False)
    industry = Column(String)
    size = Column(String)
    website = Column(String)
    description = Column(Text)
    primary_color = Column(String)
    secondary_color = Column(String)
    accent_color = Column(String)
    logo_url = Column(String)
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)

# models/user.py
class User(Base):
    id = Column(UUID, primary_key=True)
    company_id = Column(UUID, ForeignKey("companies.id"), nullable=False)
    email = Column(String, unique=True, nullable=False)
    first_name = Column(String, nullable=False)
    last_name = Column(String, nullable=False)
    password_hash = Column(String, nullable=False)
    role = Column(String, default="admin")  # admin, user
    is_active = Column(Boolean, default=True)
    created_at = Column(DateTime, default=datetime.utcnow)

# models/onboarding_flow.py
class OnboardingFlow(Base):
    id = Column(UUID, primary_key=True)
    company_id = Column(UUID, ForeignKey("companies.id"), nullable=False)
    name = Column(String, nullable=False)
    description = Column(Text)
    duration_days = Column(Integer)
    status = Column(String, default="draft")  # draft, published
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)

# models/stage.py
class Stage(Base):
    id = Column(UUID, primary_key=True)
    flow_id = Column(UUID, ForeignKey("onboarding_flows.id"), nullable=False)
    name = Column(String, nullable=False)
    description = Column(Text)
    order = Column(Integer, nullable=False)
    type = Column(String)  # text, media, form, etc.
    status = Column(String, default="active")
    created_at = Column(DateTime, default=datetime.utcnow)

# models/content_block.py
class ContentBlock(Base):
    id = Column(UUID, primary_key=True)
    stage_id = Column(UUID, ForeignKey("stages.id"), nullable=False)
    type = Column(String, nullable=False)  # content type name (header, description, etc.)
    config = Column(JSONB, nullable=False)  # validation and display configuration
    content = Column(JSONB, nullable=False)  # actual content data
    order_index = Column(Integer, nullable=False)
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)

# models/new_hire.py
class NewHire(Base):
    id = Column(UUID, primary_key=True)
    company_id = Column(UUID, ForeignKey("companies.id"), nullable=False)
    flow_id = Column(UUID, ForeignKey("onboarding_flows.id"), nullable=False)
    email = Column(String, nullable=False)
    first_name = Column(String, nullable=False)
    last_name = Column(String, nullable=False)
    status = Column(String, default="pending")  # pending, active, completed
    session_token = Column(String, unique=True)
    invited_at = Column(DateTime)
    started_at = Column(DateTime)
    completed_at = Column(DateTime)
    created_at = Column(DateTime, default=datetime.utcnow)

# models/progress.py
class Progress(Base):
    id = Column(UUID, primary_key=True)
    new_hire_id = Column(UUID, ForeignKey("new_hires.id"), nullable=False)
    stage_id = Column(UUID, ForeignKey("stages.id"), nullable=False)
    content_block_id = Column(UUID, ForeignKey("content_blocks.id"), nullable=False)
    status = Column(String, default="pending")  # pending, in_progress, completed
    started_at = Column(DateTime)
    completed_at = Column(DateTime)
    data = Column(JSONB)  # Form submissions, responses
    created_at = Column(DateTime, default=datetime.utcnow)

# models/stage_template.py
class StageTemplate(Base):
    id = Column(UUID, primary_key=True)
    name = Column(String, nullable=False)
    description = Column(Text)
    type = Column(String, nullable=False)
    default_content = Column(JSONB)
    default_config = Column(JSONB)
    is_public = Column(Boolean, default=True)
    created_at = Column(DateTime, default=datetime.utcnow)

# models/content_type.py
class ContentType(Base):
    id = Column(UUID, primary_key=True)
    name = Column(String, unique=True, nullable=False)  # header, description, etc.
    display_name = Column(String, nullable=False)
    description = Column(Text)
    category = Column(String)  # form, media, text, etc.
    default_config = Column(JSONB)  # default validation and display rules
    is_active = Column(Boolean, default=True)
    created_at = Column(DateTime, default=datetime.utcnow)
```

### 1.3 Authentication & Authorization
```python
# auth/jwt.py
class JWTToken:
    def create_access_token(data: dict)
    def verify_token(token: str)
    def get_current_user(token: str)

# auth/permissions.py
class PermissionChecker:
    def check_company_access(user_id: UUID, company_id: UUID)
    def check_flow_access(user_id: UUID, flow_id: UUID)
```

---

## Milestone 2: Core API Endpoints

### 2.1 Authentication Endpoints
```python
# api/auth.py
@router.post("/login")
@router.post("/register")
@router.post("/forgot-password")
@router.post("/reset-password")
@router.post("/refresh-token")
```

### 2.2 Company Management
```python
# api/companies.py
@router.get("/companies/{company_id}")
@router.patch("/companies/{company_id}")
@router.post("/companies/{company_id}/logo")
@router.get("/companies/{company_id}/subscription")
```

### 2.3 Onboarding Flows
```python
# api/flows.py
@router.get("/companies/{company_id}/flows")
@router.post("/companies/{company_id}/flows")
@router.get("/flows/{flow_id}")
@router.patch("/flows/{flow_id}")
@router.delete("/flows/{flow_id}")
@router.get("/flows/{flow_id}/stages")
@router.post("/flows/{flow_id}/stages")
@router.get("/flows/{flow_id}/pipeline")
```

### 2.4 Stages & Content
```python
# api/stages.py
@router.get("/flows/{flow_id}/stages/{stage_id}")
@router.patch("/flows/{flow_id}/stages/{stage_id}")
@router.delete("/flows/{flow_id}/stages/{stage_id}")
@router.get("/flows/{flow_id}/stages/{stage_id}/content-blocks")
@router.post("/flows/{flow_id}/stages/{stage_id}/content-blocks")
@router.patch("/flows/{flow_id}/stages/{stage_id}/content-blocks/{content_block_id}")
@router.delete("/flows/{flow_id}/stages/{stage_id}/content-blocks/{content_block_id}")
@router.patch("/flows/{flow_id}/stages/{stage_id}/content-blocks/reorder")
```

### 2.5 New Hires
```python
# api/new_hires.py
@router.get("/companies/{company_id}/new-hires")
@router.post("/new-hires")
@router.get("/new-hires/{new_hire_id}")
@router.patch("/new-hires/{new_hire_id}")
@router.delete("/new-hires/{new_hire_id}")
@router.get("/new-hires/{new_hire_id}/progress")
@router.post("/new-hires/{new_hire_id}/resend-invitation")
@router.patch("/new-hires/{new_hire_id}/status")
```

### 2.6 Onboarding Session (New Hire Portal)
```python
# api/onboarding.py
@router.get("/onboarding/{session_token}")
@router.post("/onboarding/{session_token}/start")
@router.get("/onboarding/{session_token}/progress")
@router.get("/onboarding/{session_token}/current-stage")
@router.get("/onboarding/{session_token}/stages/{stage_id}")
@router.get("/onboarding/{session_token}/stages/{stage_id}/status")
@router.post("/onboarding/{session_token}/stages/{stage_id}/content-blocks/{content_block_id}/complete")
@router.post("/onboarding/{session_token}/stages/{stage_id}/complete")
@router.post("/onboarding/{session_token}/uploads")
@router.post("/onboarding/{session_token}/complete")
```

### 2.7 Content Types & Templates
```python
# api/content_types.py
@router.get("/content-types")
@router.get("/content-types/{type_name}")
@router.get("/content-types/{type_name}/config")
@router.post("/content-types/{type_name}/validate")

# api/templates.py
@router.get("/stage-templates")
@router.get("/stage-templates/{template_id}")
@router.post("/stage-templates")
@router.patch("/stage-templates/{template_id}")
@router.delete("/stage-templates/{template_id}")
```

---

## Milestone 3: Business Logic Services

### 3.1 Company Service
```python
# services/company_service.py
class CompanyService:
    def create_company(company_data: dict, admin_data: dict)
    def update_company(company_id: UUID, data: dict)
    def upload_logo(company_id: UUID, file: UploadFile)
    def get_company_stats(company_id: UUID)
```

### 3.2 Flow Service
```python
# services/flow_service.py
class FlowService:
    def create_flow(company_id: UUID, flow_data: dict)
    def update_flow(flow_id: UUID, data: dict)
    def add_stage(flow_id: UUID, stage_data: dict, template_id: UUID = None)
    def update_stage(flow_id: UUID, stage_id: UUID, data: dict)
    def get_pipeline_data(flow_id: UUID)
```

### 3.3 Content Service
```python
# services/content_service.py
class ContentService:
    def add_content_block(stage_id: UUID, content_type: str, config: dict, content: dict, position: int)
    def update_content_block(content_block_id: UUID, config: dict, content: dict)
    def reorder_content_blocks(stage_id: UUID, order_data: list)
    def get_content_block(content_block_id: UUID)
    def delete_content_block(content_block_id: UUID)
    def validate_content_block(content_type: str, config: dict, content: dict)
```

### 3.4 New Hire Service
```python
# services/new_hire_service.py
class NewHireService:
    def create_new_hire(company_id: UUID, new_hire_data: dict)
    def send_invitation(new_hire_id: UUID)
    def resend_invitation(new_hire_id: UUID)
    def get_progress(new_hire_id: UUID)
    def get_progress_by_stage(new_hire_id: UUID, stage_id: UUID)
    def get_progress_by_content_block(new_hire_id: UUID, content_block_id: UUID)
    def is_stage_complete(new_hire_id: UUID, stage_id: UUID) -> bool
    def update_progress(new_hire_id: UUID, stage_id: UUID, content_block_id: UUID, data: dict)
```

### 3.5 Onboarding Session Service
```python
# services/onboarding_service.py
class OnboardingSessionService:
    def start_onboarding(session_token: str)
    def get_current_stage(session_token: str)
    def get_stage_with_content_blocks(session_token: str, stage_id: UUID)
    def complete_content_block(session_token: str, stage_id: UUID, content_block_id: UUID, data: dict)
    def is_stage_complete(session_token: str, stage_id: UUID) -> bool
    def complete_stage(session_token: str, stage_id: UUID)
    def get_progress_overview(session_token: str)
    def upload_file(session_token: str, file: UploadFile)
    def complete_onboarding(session_token: str)
```

### 3.6 Content Type Service
```python
# services/content_type_service.py
class ContentTypeService:
    def get_all_content_types() -> list
    def get_content_type(name: str) -> dict
    def get_content_type_config(name: str) -> dict
    def validate_content_type_data(content_type: str, data: dict) -> ValidationResult
    def register_content_type(name: str, config: dict)
    def update_content_type(name: str, config: dict)
```

---

## Milestone 4: File Storage & Media Handling

### 4.1 File Upload Service
```python
# services/file_service.py
class FileService:
    def upload_file(file: UploadFile, folder: str)
    def delete_file(file_url: str)
    def get_presigned_url(file_key: str)
```

### 4.2 Media Processing
```python
# services/media_service.py
class MediaService:
    def process_image(file: UploadFile)
    def generate_thumbnails(image_url: str)
    def validate_file_type(file: UploadFile, allowed_types: list)
```

---

## Milestone 5: Background Tasks & Notifications

### 5.1 Email Service
```python
# services/email_service.py
class EmailService:
    def send_welcome_email(new_hire_id: UUID)
    def send_invitation_email(new_hire_id: UUID)
    def send_reminder_email(new_hire_id: UUID)
    def send_completion_email(new_hire_id: UUID)
```

### 5.2 Background Task Queue
```python
# services/task_service.py
class TaskService:
    def queue_email_task(task_type: str, data: dict)
    def queue_file_processing(file_id: UUID)
    def queue_analytics_update(company_id: UUID)
```

---

## Milestone 6: Data Validation & Schemas

### 6.1 Pydantic Schemas
```python
# schemas/company.py
class CompanyCreate(BaseModel)
class CompanyUpdate(BaseModel)
class CompanyResponse(BaseModel)

# schemas/flow.py
class FlowCreate(BaseModel)
class FlowUpdate(BaseModel)
class FlowResponse(BaseModel)

# schemas/stage.py
class StageCreate(BaseModel)
class StageUpdate(BaseModel)
class StageResponse(BaseModel)

# schemas/content_block.py
class ContentBlockCreate(BaseModel)
class ContentBlockUpdate(BaseModel)
class ContentBlockResponse(BaseModel)
class ContentBlockReorder(BaseModel)

# schemas/content_type.py
class ContentTypeResponse(BaseModel)
class ContentTypeConfig(BaseModel)
class ContentTypeValidation(BaseModel)

# schemas/new_hire.py
class NewHireCreate(BaseModel)
class NewHireUpdate(BaseModel)
class NewHireResponse(BaseModel)

# schemas/onboarding.py
class OnboardingSession(BaseModel)
class StageCompletion(BaseModel)
class ContentBlockCompletion(BaseModel)
class ProgressOverview(BaseModel)
class FileUpload(BaseModel)
```

### 6.2 Validation Rules
```python
# utils/validators.py
class ContentValidator:
    def validate_required(value: any, required: bool) -> ValidationResult
    def validate_length(value: str, min_length: int, max_length: int) -> ValidationResult
    def validate_file(file: UploadFile, allowed_types: list, max_size: int) -> ValidationResult
    def validate_date(date: str, min_date: str, max_date: str) -> ValidationResult
    def validate_time(time: str, min_time: str, max_time: str) -> ValidationResult
    def validate_pattern(value: str, pattern: str) -> ValidationResult
    def validate_range(value: int, min_value: int, max_value: int) -> ValidationResult
    def validate_content_block_config(config: dict, content_type: str) -> ValidationResult
```

---

## Milestone 7: Security & Performance

### 7.1 Security Implementation
```python
# security/cors.py
CORS configuration for frontend domains

# security/rate_limiting.py
Rate limiting for API endpoints

# security/encryption.py
Data encryption for sensitive fields
```

### 7.2 Performance Optimization
```python
# utils/caching.py
Redis caching for frequently accessed data

# utils/database.py
Database connection pooling
Query optimization
```

---

## Milestone 8: Testing & Documentation

### 8.1 Testing Strategy
```python
# tests/
├── test_auth.py
├── test_companies.py
├── test_flows.py
├── test_new_hires.py
├── test_onboarding.py
└── conftest.py
```

### 8.2 API Documentation
- Auto-generated OpenAPI/Swagger docs
- Postman collection
- API usage examples

---

## Progress Tracking Structure

### Overview
The progress tracking system operates at three levels:

1. **Stages:** High-level sections of the onboarding flow
2. **Content Blocks:** Individual components within each stage
3. **Progress:** User completion status for each content block

### Data Flow Example

```python
# Stage Structure
stage = {
    "id": "stage-1",
    "name": "Personal Information",
    "content_blocks": [
        {"id": "cb-1", "type": "header", "content": {"title": "Welcome"}},
        {"id": "cb-2", "type": "text_input", "content": {"label": "Full Name"}},
        {"id": "cb-3", "type": "text_input", "content": {"label": "Email"}}
    ]
}

# Progress Records (one per content block per new hire)
progress_records = [
    {
        "new_hire_id": "nh-123",
        "stage_id": "stage-1",
        "content_block_id": "cb-1",
        "status": "completed",
        "data": null  # Header has no user input
    },
    {
        "new_hire_id": "nh-123",
        "stage_id": "stage-1", 
        "content_block_id": "cb-2",
        "status": "completed",
        "data": {"value": "John Doe"}
    },
    {
        "new_hire_id": "nh-123",
        "stage_id": "stage-1",
        "content_block_id": "cb-3", 
        "status": "pending",
        "data": null
    }
]

# Stage completion logic
def is_stage_complete(stage_id: UUID, new_hire_id: UUID) -> bool:
    content_blocks = get_content_blocks(stage_id)
    completed_progress = get_completed_progress(new_hire_id, stage_id)
    return len(content_blocks) == len(completed_progress)

# Service method implementation
def is_stage_complete_service(session_token: str, stage_id: UUID) -> bool:
    new_hire = get_new_hire_by_session(session_token)
    return is_stage_complete(stage_id, new_hire.id)
```

### API Response Structure

```json
{
  "current_stage": {
    "id": "stage-1",
    "name": "Personal Information",
    "content_blocks": [
      {
        "id": "cb-1",
        "type": "header",
        "config": {...},
        "content": {"title": "Welcome"},
        "progress": {
          "status": "completed",
          "data": null
        }
      },
      {
        "id": "cb-2",
        "type": "text_input", 
        "config": {...},
        "content": {"label": "Full Name"},
        "progress": {
          "status": "completed",
          "data": {"value": "John Doe"}
        }
      },
      {
        "id": "cb-3",
        "type": "text_input",
        "config": {...}, 
        "content": {"label": "Email"},
        "progress": {
          "status": "pending",
          "data": null
        }
      }
    ]
  },
  "overall_progress": {
    "completed_stages": 2,
    "total_stages": 5,
    "percentage": 40
  }
}
```

---

## Database Migration Strategy

### Initial Migration
```sql
-- Create tables in order of dependencies
CREATE TABLE companies (...)
CREATE TABLE users (...)
CREATE TABLE onboarding_flows (...)
CREATE TABLE stages (...)
CREATE TABLE content_blocks (...)
CREATE TABLE content_types (...)
CREATE TABLE new_hires (...)
CREATE TABLE progress (...)
CREATE TABLE stage_templates (...)
```

### Indexes for Performance
```sql
-- Add indexes for common queries
CREATE INDEX idx_new_hires_company_id ON new_hires(company_id);
CREATE INDEX idx_progress_new_hire_id ON progress(new_hire_id);
CREATE INDEX idx_progress_stage_id ON progress(stage_id);
CREATE INDEX idx_progress_content_block_id ON progress(content_block_id);
CREATE INDEX idx_progress_status ON progress(status);
CREATE INDEX idx_stages_flow_id ON stages(flow_id);
CREATE INDEX idx_content_blocks_stage_id ON content_blocks(stage_id);
CREATE INDEX idx_content_blocks_type ON content_blocks(type);
CREATE INDEX idx_content_blocks_order ON content_blocks(stage_id, order_index);
CREATE INDEX idx_content_types_name ON content_types(name);
```

---

## Deployment Considerations

### Environment Configuration
```python
# config.py
class Settings:
    DATABASE_URL: str
    REDIS_URL: str
    S3_BUCKET: str
    S3_ACCESS_KEY: str
    S3_SECRET_KEY: str
    JWT_SECRET_KEY: str
    EMAIL_SERVICE_API_KEY: str
```

### Docker Configuration
```yaml
# docker-compose.yml
services:
  api:
    build: .
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=postgresql://...
  postgres:
    image: postgres:13
    environment:
      - POSTGRES_DB=onboarding
  redis:
    image: redis:6
```

This backend plan provides a comprehensive foundation for the OaaS application, covering all the functionality described in the wireframes while maintaining scalability, security, and performance. 